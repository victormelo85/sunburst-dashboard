<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Interativo — Sunburst + Indicador</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --txt:#111;
    --perfil:#f28e2c; --tam:#6f6f6f; --cap:#4d87bd; --col:#8bc34a; --fon:#8b0000;
    --shadow:0 10px 30px rgba(0,0,0,.10);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);font:500 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt)}
  .layout{
    display:grid;
    grid-template-columns: minmax(340px, 1fr) 380px; /* indicador mais estreito */
    gap:12px; max-width:1400px; margin:0 auto; padding:12px;
    align-items:start;
  }
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  #chart{width:100%; height:clamp(360px, 66vh, 820px);} /* sem corte em embed */
  h1{margin:0 0 6px;font-size:16px}
  .muted{color:#6b7280;font-size:12px}
  .ind-title{display:flex;align-items:flex-end;gap:6px}
  .chip{padding:3px 8px;border-radius:999px;background:#eef2ff;color:#334155;font-weight:600;font-size:10.5px}
  .rows{margin-top:6px}
  .row{display:flex;align-items:center;gap:10px;margin:10px 0}
  .label{min-width:200px;font-size:12.5px;color:#374151}
  .pct{margin-left:auto;font-weight:800;font-size:22px;color:#111}
  .bar{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
  .fill{height:100%}
  .legend{display:flex;gap:12px;margin-top:8px;font-size:12px;color:#4b5563;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<div class="layout">
  <!-- ESQUERDA: SUNBURST -->
  <div class="card">
    <h1>Caracterização de Fornecedores de lenha e cavaco - RS</h1>
    <div id="chart"></div>
    <div class="muted">Clique no gráfico para atualizar o indicador ao lado. Passe o mouse para ver <b>Total</b> e <b>%</b>.</div>
  </div>

  <!-- DIREITA: INDICADOR DINÂMICO (fonte reduzida) -->
  <div class="card" id="panel">
    <div class="ind-title">
      <h1 id="indTitle">—</h1>
      <span class="chip" id="indChip">selecionado: —</span>
    </div>
    <div class="rows" id="rows"></div>
    <div class="legend" id="legend"></div>
    <div class="muted" style="margin-top:6px">Caracterização de Fornecedores (seus dados)</div>
  </div>
</div>

<script>
  // ---------- CONFIG ----------
  const DEFAULT_THEME = "Colheita Florestal";

  // ---------- DADOS (ajustados) ----------
  const data = {
    name: "Caracterização",
    children: [
      { name: "Perfil", children: [
        { name: "Silvicultor", value: 25 },
        { name: "Compra madeira em pé", value: 5 }
      ]},
      { name: "Tamanho Propriedade", children: [
        { name: "Pequena (<10ha)", value: 13 },
        { name: "Médio (10ha<100ha)", value: 10 },
        { name: "Grande (>100ha)", value: 7 }
      ]},
      { name: "Capacidade de Fornecimento", children: [
        { name: "Grande (> 10.000 m3/ano)", value: 13 },
        { name: "Médio (1.000 - 10.000 m3/ano)", value: 8 },
        { name: "Pouco (1-1.000 m3/ano)", value: 9 }
      ]},
      { name: "Colheita Florestal", children: [
        { name: "Mecanizada", value: 8 },
        { name: "Semimecanizada", value: 22 }
      ]},
      { name: "Fonte de Madeira", children: [
        { name: "Própria", value: 13 },
        { name: "Própria/Terceiros", value: 9 },
        { name: "Terceiros", value: 8 }
      ]}
    ]
  };

  // Cores do sunburst (hex)
  const themeColorHEX = {
    "Perfil": "#f28e2c",
    "Tamanho Propriedade": "#6f6f6f",
    "Capacidade de Fornecimento": "#4d87bd",
    "Colheita Florestal": "#8bc34a",
    "Fonte de Madeira": "#8b0000"
  };

  function colorize(node){
    if(node.children){
      node.itemStyle = node.itemStyle || {};
      node.itemStyle.color = themeColorHEX[node.name] || node.itemStyle.color;
      node.children.forEach(c=>{
        c.itemStyle = c.itemStyle || {};
        c.itemStyle.color = themeColorHEX[node.name] || c.itemStyle.color;
      });
      node.children.forEach(colorize);
    }
  }
  data.children.forEach(colorize);

  // util
  function sumChildren(node){ return (node.children||[]).reduce((s,c)=>s+(c.value||0),0); }
  function wrap(name, max){ const w=String(name).split(' '), out=[]; let cur='';
    w.forEach(s=>{ const t=(cur+' '+s).trim(); if(t.length>max){ if(cur) out.push(cur); cur=s; } else cur=t; });
    if(cur) out.push(cur); return out.join('\n');
  }

  const chart = echarts.init(document.getElementById('chart'));
  chart.setOption({
    series: [{
      type: 'sunburst',
      data: data.children,
      radius: [50, '90%'],
      sort: null,
      nodeClick: false,
      emphasis: { focus: 'self' },
      label: {
        show: true, rotate: 'tangential', minAngle: 4,
        color: '#fff', textShadowColor: 'rgba(0,0,0,.45)', textShadowBlur: 2,
        rich:{w:{color:'#fff',fontSize:8,lineHeight:10,textShadowColor:'rgba(0,0,0,.45)',textShadowBlur:2}},
        formatter: p=>`{w|${wrap(p.name,14)}}`
      },
      levels: [
        {},
        { r0:50, r:120,
          label:{
            rotate:0,
            rich:{w:{color:'#fff',fontSize:8,lineHeight:10,textShadowColor:'rgba(0,0,0,.45)',textShadowBlur:2}},
            formatter: p=>`{w|${wrap(p.name,18)}}`
          }
        },
        { r0:120, r:'90%',
          label:{
            rotate:'tangential',
            rich:{w:{color:'#fff',fontSize:8,lineHeight:10,textShadowColor:'rgba(0,0,0,.45)',textShadowBlur:2}},
            formatter: p=>`{w|${wrap(p.name,14)}}`
          }
        }
      ]
    }],
    tooltip: {
      trigger: 'item',
      borderWidth: 0,
      backgroundColor: 'rgba(17,17,17,.9)',
      textStyle: { color:'#fff', fontSize:12 },
      padding:8,
      formatter: (p) => {
        const path = (p.treePathInfo||[]).map(d=>d.name).slice(1);
        let pct=0, base=0;
        if ((p.treePathInfo||[]).length >= 3) {
          const themeName = p.treePathInfo[1].name;
          const themeNode = data.children.find(d=>d.name===themeName);
          base = sumChildren(themeNode);
        } else {
          base = data.children.reduce((s,n)=> s + sumChildren(n), 0);
        }
        pct = base ? (p.value / base * 100) : 0;
        return `<b>${path.join(' → ')}</b><br/>Total: <b>${p.value}</b><br/>Percentual: <b>${pct.toFixed(1)}%</b>`;
      }
    }
  });

  // -------- INDICADOR (com tipografia menor) --------
  const rowsEl   = document.getElementById('rows');
  const legendEl = document.getElementById('legend');
  const titleEl  = document.getElementById('indTitle');
  const chipEl   = document.getElementById('indChip');

  const colorsPanel = {
    perfil: { a:"var(--perfil)", b:"#f7b267" },
    tamanho: { a:"var(--tam)", b:"#8a8a8a", c:"#a3a3a3" },
    capacidade: { a:"var(--cap)", b:"#6ba1d3", c:"#88b8e3" },
    colheita: { a:"var(--col)", b:"#5e9e2f" },
    fonte: { a:"var(--fon)", b:"#a63838", c:"#c25b5b" }
  };

  const indicatorMap = {
    "Perfil": [
      { key:"Silvicultor",              color: colorsPanel.perfil.a },
      { key:"Compra madeira em pé",    color: colorsPanel.perfil.b }
    ],
    "Tamanho Propriedade": [
      { key:"Pequena (<10ha)",         color: colorsPanel.tamanho.a },
      { key:"Médio (10ha<100ha)",      color: colorsPanel.tamanho.b },
      { key:"Grande (>100ha)",         color: colorsPanel.tamanho.c }
    ],
    "Capacidade de Fornecimento": [
      { key:"Grande (> 10.000 m3/ano)",   color: colorsPanel.capacidade.a },
      { key:"Médio (1.000 - 10.000 m3/ano)", color: colorsPanel.capacidade.b },
      { key:"Pouco (1-1.000 m3/ano)",      color: colorsPanel.capacidade.c }
    ],
    "Colheita Florestal": [
      { key:"Semimecanizada",           color: colorsPanel.colheita.a },
      { key:"Mecanizada",               color: colorsPanel.colheita.b }
    ],
    "Fonte de Madeira": [
      { key:"Própria",                  color: colorsPanel.fonte.a },
      { key:"Própria/Terceiros",        color: colorsPanel.fonte.b },
      { key:"Terceiros",                color: colorsPanel.fonte.c }
    ]
  };

  function getThemeValues(theme){
    const node = data.children.find(d=>d.name===theme);
    if(!node) return [];
    return node.children.map(c=>({ name:c.name, value:c.value }));
  }

  function renderIndicator(theme, clickedLabel){
    const defs = indicatorMap[theme]; if(!defs) return;
    const vals = getThemeValues(theme);
    const total = vals.reduce((s,x)=>s+x.value,0);

    titleEl.textContent = theme;
    chipEl.textContent  = clickedLabel ? `selecionado: ${clickedLabel}` : 'selecionado: —';
    rowsEl.innerHTML = ''; legendEl.innerHTML = '';

    defs.forEach(def=>{
      const v = (vals.find(x=>x.name===def.key) || {value:0}).value;
      const pct = total? (Math.round(v/total*1000)/10) : 0;
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `
        <div class="label">${def.key}</div>
        <div class="pct">${pct.toFixed(1)}%</div>
      `;
      const bar = document.createElement('div'); bar.className='bar';
      const fill= document.createElement('div'); fill.className='fill';
      fill.style.background = def.color; fill.style.width = pct+'%';
      bar.appendChild(fill); rowsEl.appendChild(row); rowsEl.appendChild(bar);

      const lg = document.createElement('div'); lg.style.display='flex'; lg.style.alignItems='center'; lg.style.gap='6px';
      lg.innerHTML = `<span class="dot" style="background:${def.color}"></span> ${def.key}`;
      legendEl.appendChild(lg);
    });
  }

  // inicial
  renderIndicator(DEFAULT_THEME);

  // clique numa fatia → atualiza painel pelo TEMA
  chart.on('click', (p)=>{
    const tpi = p.treePathInfo || [];
    const theme = tpi[1] ? tpi[1].name : p.name;
    if (indicatorMap[theme]) {
      const clickedLabel = (tpi.length>=3 ? tpi[2].name : '');
      renderIndicator(theme, clickedLabel);
    }
  });

  window.addEventListener('resize', ()=>chart.resize());
</script>
</body>
</html>
